<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepAgents 系统架构图</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@700&family=JetBrains+Mono:wght@400;500&family=Noto+Serif+SC:wght@400;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'JetBrains Mono', 'Noto Serif SC', monospace;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
            padding: 40px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            padding: 48px;
        }

        .main-title {
            font-family: 'Fira Code', 'Noto Serif SC', monospace;
            font-size: 24pt;
            font-weight: 700;
            text-align: center;
            color: #1e293b;
            margin-bottom: 12px;
            letter-spacing: -0.5px;
        }

        .subtitle {
            font-family: 'JetBrains Mono', 'Noto Serif SC', monospace;
            font-size: 14pt;
            text-align: center;
            color: #64748b;
            margin-bottom: 40px;
        }

        .architecture-svg {
            width: 100%;
            height: auto;
        }

        .layer-box {
            fill: #f8fafc;
            stroke: #cbd5e1;
            stroke-width: 2;
            rx: 12;
        }

        .core-box {
            fill: #fef3c7;
            stroke: #f59e0b;
            stroke-width: 2;
            rx: 8;
        }

        .middleware-box {
            fill: #dbeafe;
            stroke: #3b82f6;
            stroke-width: 2;
            rx: 8;
        }

        .service-box {
            fill: #dcfce7;
            stroke: #22c55e;
            stroke-width: 2;
            rx: 8;
        }

        .ui-box {
            fill: #fce7f3;
            stroke: #ec4899;
            stroke-width: 2;
            rx: 8;
        }

        .skill-box {
            fill: #e0e7ff;
            stroke: #6366f1;
            stroke-width: 2;
            rx: 8;
        }

        .rpa-box {
            fill: #ffedd5;
            stroke: #f97316;
            stroke-width: 2;
            rx: 8;
        }

        .layer-title {
            font-family: 'Fira Code', 'Noto Serif SC', monospace;
            font-size: 16px;
            font-weight: 700;
            fill: #1e293b;
        }

        .component-title {
            font-family: 'JetBrains Mono', 'Noto Serif SC', monospace;
            font-size: 13px;
            font-weight: 500;
            fill: #334155;
        }

        .component-desc {
            font-family: 'JetBrains Mono', 'Noto Serif SC', monospace;
            font-size: 11px;
            fill: #64748b;
        }

        .formula {
            font-family: 'Latin Modern Math', 'Times New Roman', serif;
            font-size: 12px;
            fill: #7c3aed;
            font-style: italic;
        }

        .tech-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            fill: #94a3b8;
        }

        .connector {
            stroke: #94a3b8;
            stroke-width: 2;
            fill: none;
            stroke-dasharray: 6,4;
        }

        .connector-solid {
            stroke: #64748b;
            stroke-width: 2;
            fill: none;
        }

        .arrow-head {
            fill: #64748b;
        }

        .legend {
            margin-top: 32px;
            padding: 24px;
            background: #f8fafc;
            border-radius: 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 24px;
            justify-content: center;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: 'JetBrains Mono', 'Noto Serif SC', monospace;
            font-size: 12px;
            color: #475569;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 2px solid;
        }

        .formula-section {
            margin-top: 32px;
            padding: 24px;
            background: #faf5ff;
            border-radius: 12px;
            border: 1px solid #e9d5ff;
        }

        .formula-title {
            font-family: 'Fira Code', 'Noto Serif SC', monospace;
            font-size: 16px;
            font-weight: 700;
            color: #7c3aed;
            margin-bottom: 16px;
        }

        .formula-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
        }

        .formula-card {
            background: white;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #e9d5ff;
        }

        .formula-card h4 {
            font-family: 'JetBrains Mono', 'Noto Serif SC', monospace;
            font-size: 13px;
            color: #6b21a8;
            margin-bottom: 8px;
        }

        .formula-card .math {
            font-family: 'Latin Modern Math', 'Times New Roman', serif;
            font-size: 14px;
            color: #1e293b;
            font-style: italic;
        }

        .formula-card .desc {
            font-family: 'JetBrains Mono', 'Noto Serif SC', monospace;
            font-size: 11px;
            color: #64748b;
            margin-top: 8px;
        }

        .tech-summary {
            margin-top: 32px;
            padding: 24px;
            background: #f0fdf4;
            border-radius: 12px;
            border: 1px solid #bbf7d0;
        }

        .tech-summary h3 {
            font-family: 'Fira Code', 'Noto Serif SC', monospace;
            font-size: 16px;
            font-weight: 700;
            color: #166534;
            margin-bottom: 16px;
        }

        .tech-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .tech-card {
            background: white;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #bbf7d0;
        }

        .tech-card h4 {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: #166534;
            margin-bottom: 6px;
        }

        .tech-card p {
            font-family: 'JetBrains Mono', 'Noto Serif SC', monospace;
            font-size: 11px;
            color: #64748b;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="main-title">DeepAgents 系统架构</h1>
        <p class="subtitle">基于 LangGraph 的智能代理框架 · Monorepo 架构</p>

        <svg class="architecture-svg" viewBox="0 0 1300 900" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                    <polygon points="0 0, 10 3.5, 0 7" class="arrow-head"/>
                </marker>
                <marker id="arrowhead-up" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="270">
                    <polygon points="0 0, 10 3.5, 0 7" class="arrow-head"/>
                </marker>
            </defs>

            <!-- 表示层 Presentation Layer -->
            <rect x="20" y="20" width="1260" height="160" class="layer-box"/>
            <text x="40" y="50" class="layer-title">表示层 Presentation Layer</text>

            <!-- CLI -->
            <rect x="40" y="70" width="280" height="90" class="ui-box"/>
            <text x="60" y="95" class="component-title">deepagents-cli</text>
            <text x="60" y="115" class="component-desc">Textual TUI 终端界面</text>
            <text x="60" y="132" class="tech-label">Python · Rich · prompt-toolkit</text>
            <text x="60" y="148" class="component-desc">会话持久化 · SQLite</text>

            <!-- Web Frontend -->
            <rect x="340" y="70" width="280" height="90" class="ui-box"/>
            <text x="360" y="95" class="component-title">deepagents-web/frontend</text>
            <text x="360" y="115" class="component-desc">React SPA 单页应用</text>
            <text x="360" y="132" class="tech-label">React 18 · Vite · Tailwind CSS</text>
            <text x="360" y="148" class="component-desc">WebSocket 实时通信</text>

            <!-- Shared UI -->
            <rect x="640" y="70" width="280" height="90" class="ui-box"/>
            <text x="660" y="95" class="component-title">deepagents-ui</text>
            <text x="660" y="115" class="component-desc">共享 React 组件库</text>
            <text x="660" y="132" class="tech-label">Zustand 状态管理</text>
            <text x="660" y="148" class="component-desc">ChatArea · SkillsSidebar · ExecutionPanel</text>

            <!-- Desktop -->
            <rect x="940" y="70" width="320" height="90" class="ui-box"/>
            <text x="960" y="95" class="component-title">deepagents-desktop</text>
            <text x="960" y="115" class="component-desc">Electron 桌面应用</text>
            <text x="960" y="132" class="tech-label">Electron · IPC · electron-builder</text>
            <text x="960" y="148" class="component-desc">跨平台打包 · 本地/远程后端</text>

            <!-- 服务层 Service Layer -->
            <rect x="20" y="200" width="1260" height="200" class="layer-box"/>
            <text x="40" y="230" class="layer-title">服务层 Service Layer</text>

            <!-- Web API -->
            <rect x="40" y="250" width="380" height="130" class="service-box"/>
            <text x="60" y="275" class="component-title">deepagents-web API</text>
            <text x="60" y="295" class="component-desc">FastAPI + Uvicorn</text>
            <text x="60" y="315" class="tech-label">REST API · WebSocket /ws/chat</text>
            <text x="60" y="338" class="component-desc">├─ agent_service    代理会话管理</text>
            <text x="60" y="355" class="component-desc">├─ skill_service    技能 CRUD</text>
            <text x="60" y="372" class="component-desc">└─ recording_service 浏览器录制</text>

            <!-- RPA Engine -->
            <rect x="440" y="250" width="280" height="130" class="rpa-box"/>
            <text x="460" y="275" class="component-title">RPA Engine</text>
            <text x="460" y="295" class="component-desc">原子操作执行引擎</text>
            <text x="460" y="315" class="tech-label">ActionRegistry · VariableContext</text>
            <text x="460" y="338" class="component-desc">Browser · File · System</text>
            <text x="460" y="355" class="component-desc">Keyboard · Variable · Control</text>
            <text x="460" y="372" class="formula">T_exec = Σ(t_action + t_delay)</text>

            <!-- Hybrid Executor -->
            <rect x="740" y="250" width="280" height="130" class="rpa-box"/>
            <text x="760" y="275" class="component-title">Hybrid Executor</text>
            <text x="760" y="295" class="component-desc">混合技能执行器</text>
            <text x="760" y="315" class="tech-label">StepType: Recording | NL | RPA | SkillRef</text>
            <text x="760" y="338" class="component-desc">变量映射 · 步骤编排</text>
            <text x="760" y="355" class="component-desc">错误处理 · 重试机制</text>
            <text x="760" y="372" class="formula">V_out = f(V_in, Step_result)</text>

            <!-- Skill Executor -->
            <rect x="1040" y="250" width="220" height="130" class="service-box"/>
            <text x="1060" y="275" class="component-title">Skill Executor</text>
            <text x="1060" y="295" class="component-desc">技能执行器</text>
            <text x="1060" y="315" class="tech-label">Playwright · subprocess</text>
            <text x="1060" y="338" class="component-desc">脚本执行 · 截图捕获</text>
            <text x="1060" y="355" class="component-desc">UTF-8 输出处理</text>

            <!-- 核心层 Core Layer -->
            <rect x="20" y="420" width="1260" height="220" class="layer-box"/>
            <text x="40" y="450" class="layer-title">核心层 Core Layer · deepagents</text>

            <!-- Agent Factory -->
            <rect x="40" y="470" width="240" height="150" class="core-box"/>
            <text x="60" y="495" class="component-title">Agent Factory</text>
            <text x="60" y="515" class="component-desc">graph.py</text>
            <text x="60" y="535" class="tech-label">create_deep_agent()</text>
            <text x="60" y="558" class="component-desc">LangGraph StateGraph</text>
            <text x="60" y="575" class="component-desc">中间件栈组装</text>
            <text x="60" y="595" class="formula">Agent = Σ Middleware(Graph)</text>

            <!-- Middleware System -->
            <rect x="300" y="470" width="480" height="150" class="middleware-box"/>
            <text x="320" y="495" class="component-title">Middleware System 中间件系统</text>
            <text x="320" y="518" class="component-desc">TodoListMiddleware         任务规划与进度跟踪</text>
            <text x="320" y="538" class="component-desc">FilesystemMiddleware       文件操作 (ls/read/write/edit)</text>
            <text x="320" y="558" class="component-desc">SubAgentMiddleware         子代理委托 (task 工具)</text>
            <text x="320" y="578" class="component-desc">SummarizationMiddleware    上下文摘要压缩</text>
            <text x="320" y="598" class="component-desc">HumanInTheLoopMiddleware   人机协同审批</text>
            <text x="320" y="615" class="formula">Context_new = Summarize(C) when tokens > 170k</text>

            <!-- Backend System -->
            <rect x="800" y="470" width="460" height="150" class="core-box"/>
            <text x="820" y="495" class="component-title">Backend System 后端抽象层</text>
            <text x="820" y="518" class="component-desc">BackendProtocol: ls | read | write | edit | glob | grep</text>
            <text x="820" y="545" class="component-desc">StateBackend           临时内存存储 (默认)</text>
            <text x="820" y="565" class="component-desc">FilesystemBackend      真实磁盘操作</text>
            <text x="820" y="585" class="component-desc">CompositeBackend       混合路由策略</text>
            <text x="820" y="605" class="component-desc">SandboxBackend         沙箱执行环境</text>

            <!-- 技能层 Skill Layer -->
            <rect x="20" y="660" width="840" height="140" class="layer-box"/>
            <text x="40" y="690" class="layer-title">技能层 Skill Layer</text>

            <!-- Browser Skill -->
            <rect x="40" y="710" width="190" height="70" class="skill-box"/>
            <text x="60" y="735" class="component-title">Browser Skill</text>
            <text x="60" y="755" class="component-desc">Playwright 脚本</text>
            <text x="60" y="770" class="tech-label">SKILL.md + script.py</text>

            <!-- RPA Skill -->
            <rect x="250" y="710" width="190" height="70" class="skill-box"/>
            <text x="270" y="735" class="component-title">RPA Skill</text>
            <text x="270" y="755" class="component-desc">原子操作工作流</text>
            <text x="270" y="770" class="tech-label">SKILL.md + workflow.json</text>

            <!-- Hybrid Skill -->
            <rect x="460" y="710" width="190" height="70" class="skill-box"/>
            <text x="480" y="735" class="component-title">Hybrid Skill</text>
            <text x="480" y="755" class="component-desc">混合步骤编排</text>
            <text x="480" y="770" class="tech-label">SKILL.md + definition.json</text>

            <!-- NL Skill -->
            <rect x="670" y="710" width="170" height="70" class="skill-box"/>
            <text x="690" y="735" class="component-title">NL Skill</text>
            <text x="690" y="755" class="component-desc">自然语言指令</text>
            <text x="690" y="770" class="tech-label">SKILL.md</text>

            <!-- 存储层 Storage Layer -->
            <rect x="880" y="660" width="400" height="140" class="layer-box"/>
            <text x="900" y="690" class="layer-title">存储层 Storage Layer</text>

            <!-- Memory -->
            <rect x="900" y="710" width="170" height="70" class="core-box"/>
            <text x="920" y="735" class="component-title">Memory</text>
            <text x="920" y="755" class="component-desc">AGENTS.md 记忆</text>
            <text x="920" y="770" class="tech-label">全局 + 项目级</text>

            <!-- Session -->
            <rect x="1090" y="710" width="170" height="70" class="core-box"/>
            <text x="1110" y="735" class="component-title">Session</text>
            <text x="1110" y="755" class="component-desc">会话持久化</text>
            <text x="1110" y="770" class="tech-label">SQLite · LangGraph Store</text>

            <!-- 外部依赖 External -->
            <rect x="20" y="820" width="1260" height="60" class="layer-box" style="fill:#fef2f2; stroke:#ef4444;"/>
            <text x="40" y="850" class="layer-title" style="fill:#dc2626;">外部依赖 External Dependencies</text>
            <text x="300" y="855" class="component-desc">LangGraph · LangChain · Playwright · Claude API · OpenAI API</text>
            <text x="900" y="855" class="tech-label">Model: Claude Sonnet 4.5 (default) | GPT-4o | Custom</text>

            <!-- 连接线 -->
            <path d="M 180 160 L 180 250" class="connector-solid" marker-end="url(#arrowhead)"/>
            <path d="M 480 160 L 230 250" class="connector-solid" marker-end="url(#arrowhead)"/>
            <path d="M 780 160 L 580 250" class="connector-solid" marker-end="url(#arrowhead)"/>
            <path d="M 1100 160 L 1150 250" class="connector-solid" marker-end="url(#arrowhead)"/>

            <path d="M 230 380 L 160 470" class="connector-solid" marker-end="url(#arrowhead)"/>
            <path d="M 580 380 L 540 470" class="connector-solid" marker-end="url(#arrowhead)"/>
            <path d="M 880 380 L 880 470" class="connector-solid" marker-end="url(#arrowhead)"/>
            <path d="M 1150 380 L 1030 470" class="connector-solid" marker-end="url(#arrowhead)"/>

            <path d="M 540 620 L 440 710" class="connector" marker-end="url(#arrowhead)"/>

            <path d="M 1030 620 L 985 710" class="connector" marker-end="url(#arrowhead)"/>
            <path d="M 1030 620 L 1175 710" class="connector" marker-end="url(#arrowhead)"/>

            <line x1="230" y1="745" x2="250" y2="745" class="connector-solid"/>
            <line x1="440" y1="745" x2="460" y2="745" class="connector-solid"/>
            <line x1="650" y1="745" x2="670" y2="745" class="connector-solid"/>
        </svg>

        <!-- 图例 -->
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background:#fce7f3; border-color:#ec4899;"></div>
                <span>表示层 UI/CLI</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background:#dcfce7; border-color:#22c55e;"></div>
                <span>服务层 Service</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background:#fef3c7; border-color:#f59e0b;"></div>
                <span>核心层 Core</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background:#dbeafe; border-color:#3b82f6;"></div>
                <span>中间件 Middleware</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background:#e0e7ff; border-color:#6366f1;"></div>
                <span>技能 Skill</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background:#ffedd5; border-color:#f97316;"></div>
                <span>RPA/Hybrid</span>
            </div>
        </div>

        <!-- 关键公式说明 -->
        <div class="formula-section">
            <h3 class="formula-title">关键计算公式 Key Formulas</h3>
            <div class="formula-grid">
                <div class="formula-card">
                    <h4>上下文摘要触发条件</h4>
                    <div class="math">Summarize(C) ⟺ |C|<sub>tokens</sub> > min(170k, 0.85 × M<sub>max</sub>)</div>
                    <div class="desc">当上下文 tokens 超过阈值时触发摘要，保留最近 6 条消息</div>
                </div>
                <div class="formula-card">
                    <h4>RPA 执行时间</h4>
                    <div class="math">T<sub>total</sub> = Σ<sub>i=1</sub><sup>n</sup> (t<sub>action,i</sub> + t<sub>delay_before,i</sub> + t<sub>delay_after,i</sub>)</div>
                    <div class="desc">总执行时间 = 所有动作执行时间 + 延迟时间之和</div>
                </div>
                <div class="formula-card">
                    <h4>混合技能变量传递</h4>
                    <div class="math">V<sub>out</sub> = f(V<sub>in</sub>, R<sub>step</sub>) where V<sub>in</sub> = ∪ input_mappings</div>
                    <div class="desc">输出变量由输入映射和步骤执行结果共同决定</div>
                </div>
                <div class="formula-card">
                    <h4>技能渐进式加载</h4>
                    <div class="math">Load(S) = { metadata(S) if idle, full(S) if requested }</div>
                    <div class="desc">启动时仅加载元数据，按需读取完整技能内容</div>
                </div>
            </div>
        </div>

        <!-- 技术栈摘要 -->
        <div class="tech-summary">
            <h3>技术栈摘要 Technology Stack</h3>
            <div class="tech-grid">
                <div class="tech-card">
                    <h4>Backend</h4>
                    <p>Python ≥3.11 · LangGraph · LangChain · FastAPI · Uvicorn · Playwright</p>
                </div>
                <div class="tech-card">
                    <h4>Frontend</h4>
                    <p>React 18 · Zustand · Tailwind CSS · Vite · react-markdown</p>
                </div>
                <div class="tech-card">
                    <h4>Desktop</h4>
                    <p>Electron · IPC · electron-builder · ECharts</p>
                </div>
                <div class="tech-card">
                    <h4>CLI</h4>
                    <p>Textual · Rich · prompt-toolkit · SQLite</p>
                </div>
                <div class="tech-card">
                    <h4>Storage</h4>
                    <p>SQLite · LangGraph Store · InMemoryStore · Filesystem</p>
                </div>
                <div class="tech-card">
                    <h4>LLM</h4>
                    <p>Claude Sonnet 4.5 (default) · GPT-4o · Custom Models</p>
                </div>
            </div>
        </div>
    </div>
</body>
</html>