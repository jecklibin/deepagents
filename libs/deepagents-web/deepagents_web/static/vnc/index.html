<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>DeepAgents Remote Browser</title>
    <style>
      :root {
        color-scheme: dark;
      }
      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
        background: #0f172a;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, sans-serif;
      }
      #screen {
        width: 100%;
        height: 100%;
        display: block;
      }
      #overlay {
        position: absolute;
        top: 16px;
        left: 16px;
        padding: 8px 12px;
        background: rgba(15, 23, 42, 0.7);
        border: 1px solid rgba(148, 163, 184, 0.2);
        border-radius: 10px;
        color: #e2e8f0;
        font-size: 12px;
        z-index: 10;
      }
      #overlay.connected {
        color: #34d399;
      }
      #overlay.error {
        color: #f87171;
      }
      #root {
        position: relative;
        width: 100%;
        height: 100%;
      }
    </style>
  </head>
  <body>
    <div id="root">
      <div id="overlay">Connecting...</div>
      <div id="screen"></div>
    </div>
    <script type="module">
      const overlay = document.getElementById('overlay');
      const screen = document.getElementById('screen');

      const setStatus = (message, tone) => {
        overlay.textContent = message;
        overlay.classList.remove('connected', 'error');
        if (tone) {
          overlay.classList.add(tone);
        }
      };

      const config = await fetch('/api/vnc/config')
        .then((res) => (res.ok ? res.json() : null))
        .catch(() => null);

      const wsUrl =
        config?.ws_url ||
        `${window.location.protocol === 'https:' ? 'wss:' : 'ws:'}//${window.location.host}/api/vnc/ws`;

      let RFBModule = null;
      try {
        RFBModule = await import('https://cdn.jsdelivr.net/npm/@novnc/novnc/core/rfb.js');
      } catch (error) {
        setStatus('Failed to load noVNC client.', 'error');
      }

      if (RFBModule?.default) {
        const rfb = new RFBModule.default(screen, wsUrl, { shared: true });
        rfb.viewOnly = Boolean(config?.view_only);
        rfb.scaleViewport = true;
        rfb.resizeSession = true;

        rfb.addEventListener('connect', () => {
          setStatus('Connected', 'connected');
        });
        rfb.addEventListener('disconnect', () => {
          setStatus('Disconnected', 'error');
        });
        rfb.addEventListener('credentialsrequired', () => {
          if (config?.password) {
            rfb.sendCredentials({ password: config.password });
          } else {
            setStatus('VNC password required.', 'error');
          }
        });
      }
    </script>
  </body>
</html>
